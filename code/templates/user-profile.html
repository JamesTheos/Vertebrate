{% extends "basesettings.html" %}
{% block title %}User Profile{% endblock %}
{% block header_title %}User Settings{% endblock %}
{% block content %}



<form id="updateUserForm">
    <div>
        <label for="usernameUpdate">Username:</label>
        <input type="text" id="usernameUpdate" name="username"
               value="{{ current_user.username }}" required>
    </div>
    <div>
        <label for="passwordUpdate">New Password:</label>
        <input type="password" id="passwordUpdate" name="password" placeholder="Leave empty to keep current">
    </div>
    <div>
    <label for="confirmPasswordUpdate">Confirm Password:</label>
        <input type="password" id="confirmPasswordUpdate" name="confirm_password">
    </div>
    <div>
        <label for="roleUpdate">Roles:</label>
        <select name="roles" id="roleUpdate" multiple required>
            {% for role in roles %}
                <option value="{{ role.id }}"
                    {% if role in current_user.roles %}
                        selected
                    {% endif %}
                >{{ role.name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit">Update User</button>
</form>


<script>
const usernameInput = document.getElementById('usernameUpdate');
const passwordInput = document.getElementById('passwordUpdate');
const confirmPasswordInput = document.getElementById('confirmPasswordUpdate');
const roleSelect = document.getElementById('roleUpdate');
const updateForm = document.getElementById('updateUserForm');
const updateButton = updateForm.querySelector('button[type="submit"]');

// Validierungen
function validateForm() {
    const usernameValid = usernameInput.value.trim().length > 0;
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const passwordsMatch = password === confirmPassword;
    const rolesSelected = roleSelect.selectedOptions.length > 0;

    updateButton.disabled = !usernameValid || (password && !passwordsMatch) || !rolesSelected;
}

// Event Listener
usernameInput.addEventListener('input', validateForm);
passwordInput.addEventListener('input', validateForm);
confirmPasswordInput.addEventListener('input', validateForm);
roleSelect.addEventListener('change', validateForm);

// Formular-Submit
updateForm.addEventListener('submit', async function (e) {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const selectedRoles = Array.from(roleSelect.selectedOptions).map(opt => parseInt(opt.value));

    if (!username) {
        alert("Username is required.");
        return;
    }

    if (password && password !== confirmPassword) {
        alert("Passwords do not match.");
        return;
    }

    if (selectedRoles.length === 0) {
        alert("Please select at least one role.");
        return;
    }

    const payload = {
        username: username,
        roles: selectedRoles
    };

    if (password.length > 0) {
        payload.password = password;
    }

    const response = await fetch('/UpdateUser', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    if (response.ok) {
        const data = await response.json();
        alert(data.message || "User updated successfully.");
        window.location.reload();
    } else {
        const errorText = await response.text();
        alert("Update failed: " + errorText);
    }
});

// Initial validieren
validateForm();
</script>

<style>
select[multiple] {
    min-width: 200px;
    height: 100px;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: #fff;
    color: #222;
}
</style>

{% endblock %}