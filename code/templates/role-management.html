{% extends "basesettings.html" %}

{% block title %}Settings{% endblock %}
{% block header_title %}Role Management{% endblock %}

{% block content %}
<div class="role-management-container">
    <div id="role-modal" class="modal">
        <div class="modal-content">
            <h3>Add / Edit Role</h3>
            <form id="role-form">
                <fieldset>
                    <legend>Role Details</legend>
                    <table>
                        <tr>
                            <th>Manufacturing Order:</th>
                            <td>
                                <label for="manufacturing-orders">Order Management</label>
                                <input type="checkbox" id="manufacturing-orders" disabled>
                            </td>
                            <td>
                                <label for="order-management">Order Overview</label>
                                <input type="checkbox" id="order-management" disabled>
                            </td>
                        </tr>
                        <tr>
                            <th>Workflow Management:</th>
                            <td>
                                <label for="workflow-overview">Workflow Overview</label>
                                <input type="checkbox" id="workflow-overview" disabled>
                            </td>
                            <td>
                                <label for="batch">Batch</label>
                                <input type="checkbox" id="batch" disabled>
                            </td>
                            <td>
                                <label for="process-instructions">Process Instructions</label>
                                <input type="checkbox" id="process-instructions" disabled>
                            </td>
                            <td>
                                <label for="sampling">Sampling</label>
                                <input type="checkbox" id="sampling" disabled>
                            </td>
                        </tr>
                        <tr>
                            <th>SCADA:</th>
                            <td>
                                <label for="equipment">Equipment</label>
                                <input type="checkbox" id="equipment" disabled>
                            </td>
                            <td>
                                <label for="pid">P&ID</label>
                                <input type="checkbox" id="pid" disabled>
                            </td>
                            <td>
                                <label for="3d-view">3D-View</label>
                                <input type="checkbox" id="3d-view" disabled>
                            </td>
                        </tr>
                        <tr>
                            <th>QBD:</th>
                            <td>
                                <label for="design-space-definition">Design Space Definition</label>
                                <input type="checkbox" id="design-space-definition" disabled>
                            </td>
                            <td>
                                <label for="design-space-representation">Design Space Representation</label>
                                <input type="checkbox" id="design-space-representation" disabled>
                            </td>
                        </tr>
                        <tr>
                            <th>Analytics:</th>
                            <td>
                                <label for="product-analytics">Product Analytics</label>
                                <input type="checkbox" id="product-analytics" disabled>
                            </td>
                            <td>
                                <label for="process-qbd-analytics">Process QBD Analytics</label>
                                <input type="checkbox" id="process-qbd-analytics" disabled>
                            </td>
                        </tr>
                        <tr>
                            <th>Settings:</th>
                            <td>
                                <label for="plant-configuration">Plant Configuration</label>
                                <input type="checkbox" id="plant-configuration" disabled>
                            </td>
                            <td>
                                <label for="process-configuration">Process Configuration</label>
                                <input type="checkbox" id="process-configuration" disabled>
                            </td>
                            <td>
                                <label for="workflow-management">Workflow Management</label>
                                <input type="checkbox" id="workflow-management" disabled>
                            </td>
                            <td>
                                <label for="user-management">User Management</label>
                                <input type="checkbox" id="user-management" disabled>
                            </td>
                            <td>
                                <label for="role-management">Role Management</label>
                                <input type="checkbox" id="role-management" disabled>
                            </td>
                        </tr>
                    </table>
                </fieldset>

                <label for="role-name">Role Name:</label>
                <input type="text" id="role-name" name="role-name">

                <button type="submit" id="add-btn" disabled>Add Role</button>
                <button type="button" id="save-btn" style="display:none;">Save Changes</button>
            </form>
        </div>

        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px; margin-bottom: 10px;">
            <h3 style="margin: 0;">Existing Roles</h3>
            <label for="role-select">Edit:</label>
            <select id="role-select">
                <option value="">-- Choose a Role --</option>
                {% for role in roles %}
                    <option value="{{ role.name }}">{{ role.name }}</option>
                {% endfor %}
            </select>
            <button type="button" id="edit-btn">Edit Role</button>
        </div>

        <ul>
            {% for role in roles %}
                <li>
                    <strong>{{ role.name }}</strong>
                    {% if role.permissions %}
                        <ul>
                            {% for perm in role.permissions %}
                                <li>{{ perm.key }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% else %}
                <li>No roles defined yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
const roleForm = document.getElementById('role-form');
const roleNameInput = document.getElementById('role-name');
const addBtn = document.getElementById('add-btn');
const saveBtn = document.getElementById('save-btn');
const editBtn = document.getElementById('edit-btn');
const roleSelect = document.getElementById('role-select');

let editingRole = null;

// Enable/disable Add button
roleNameInput.addEventListener('input', () => {
    addBtn.disabled = !roleNameInput.value.trim();
});

function collectPermissions() {
    return Array.from(roleForm.querySelectorAll('input[type="checkbox"]:checked'))
        .reduce((acc, cb) => {
            acc[cb.id] = true;
            return acc;
        }, {});
}

function populatePermissions(roleData) {
    roleForm.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    if (roleData && roleData.permissions) {
        roleData.permissions.forEach(perm => {
            const cb = document.getElementById(perm.key);
            if (cb) cb.checked = true;
        });
    }
}

roleForm.addEventListener('submit', e => {
    e.preventDefault();
    const roleName = roleNameInput.value.trim();
    if (!roleName) return;

    const checkedBoxes = collectPermissions();

    fetch('/get-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            created_role: roleName,
            role_apps: checkedBoxes
        })
    })
    .then(res => res.json())
    .then(() => {
        roleForm.reset();
        addBtn.disabled = true;
    });

    console.log("Added:", roleName, checkedBoxes);
});

editBtn.addEventListener('click', () => {
    const selectedRole = roleSelect.value;
    if (!selectedRole) return;

    fetch(`/get-role/${selectedRole}`)
        .then(res => res.json())
        .then(roleData => {
            roleNameInput.value = roleData.name;
            populatePermissions(roleData);
            editingRole = roleData.name;

            addBtn.style.display = "none";
            saveBtn.style.display = "inline-block";
        });
});

saveBtn.addEventListener('click', () => {
    if (!editingRole) return;

    const checkedBoxes = collectPermissions();
    const roleToUpdate = editingRole;

    fetch('/update-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            role_name: roleToUpdate,
            updated_role_apps: checkedBoxes
        })
    })
    .then(res => res.json())
    .then(() => {
        editingRole = null;
        roleForm.reset();
        saveBtn.style.display = "none";
        addBtn.style.display = "inline-block";
        addBtn.disabled = true;
    });

    console.log("Updated:", roleToUpdate, checkedBoxes);
});

// Enable checkboxes for subscribed apps
const subscribedAppsList = JSON.parse('{{ subscribed_apps | tojson | safe }}');
roleForm.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if (subscribedAppsList.includes(cb.id)) {
        cb.disabled = false;
    }
});
</script>
{% endblock %}
