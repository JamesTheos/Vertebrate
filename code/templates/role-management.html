{% extends "basesettings.html" %}

{% block title %}Settings{% endblock %}
{% block header_title %}Role Management{% endblock %}

{% block content %}

<div class="role-management-container">
    <div id="role-modal" class="modal">
        <div class="modal-content">
            <h3>Add / Edit Role</h3>
            <form id="role-form">
                <fieldset>
                    <legend>Role Details</legend>

                    <table>
                        <tr>
                            <th>Manufacturing Order:</th>
                            <td>Order Management<input type="checkbox" id="order-management"></td>
                            <td>Order Overview<input type="checkbox" id="order-overview"></td>
                        </tr>
                        <tr>
                            <th>Workflow Management:</th>
                            <td>Workflow Overview<input type="checkbox" id="workflow-overview"></td>
                            <td>Batch <input type="checkbox" id="batch"></td>
                            <td>Process Instructions<input type="checkbox" id="process-instructions"></td>
                            <td>Sampling<input type="checkbox" id="sampling"></td>
                        </tr>
                        <tr>
                            <th>SCADA:</th>
                            <td>Equipment <input type="checkbox" id="equipment"></td>
                            <td>P&ID<input type="checkbox" id="pid"></td>
                            <td>3D-View<input type="checkbox" id="3d-view"></td>
                        </tr>
                        <tr>
                            <th>QBD:</th>
                            <td>Design Space Definition <input type="checkbox" id="design-space-definition"></td>
                            <td>Design Space Representation <input type="checkbox" id="design-space-representation"></td>
                        </tr>
                        <tr>
                            <th>Analytics:</th>
                            <td>Product Analytics <input type="checkbox" id="product-analytics"></td>
                            <td>Process QBD Analytics <input type="checkbox" id="process-qbd-analytics"></td>
                        </tr>
                        <tr>
                            <th>Settings:</th>
                            <td>Plant Configuration<input type="checkbox" id="plant-configuration"></td>
                            <td>Process Configuration<input type="checkbox" id="process-configuration"></td>
                            <td>Workflow Management<input type="checkbox" id="workflow-management"></td>
                            <td>User Management<input type="checkbox" id="user-management"></td>
                            <td>Role Management<input type="checkbox" id="role-management"></td>
                        </tr>
                    </table>
                </fieldset>

                <label for="role-name">Role Name:</label>
                <input type="text" id="role-name" name="role-name">

                <button type="submit" id="add-btn">Add Role</button>
                <button type="button" id="save-btn" style="display:none;">Save Changes</button>
            </form>
        </div>

        <!-- Existing Roles + Dropdown inline -->
        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px; margin-bottom: 10px;">
            <h3 style="margin: 0;">Existing Roles</h3>
            <label for="role-select">Edit:</label>
            <select id="role-select">
                <option value="">-- Choose a Role --</option>
                {% for role in roles %}
                    <option value="{{ role.name }}">{{ role.name }}</option>
                {% endfor %}
            </select>
            <button type="button" id="edit-btn">Edit Role</button>
        </div>

        <ul>
            {% for role in roles %}
                <li>
                    <strong>{{ role.name }}</strong>
                    {% if role.permissions %}
                        <ul>
                            {% for perm in role.permissions %}
                                <li>{{ perm.key }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% else %}
                <li>No roles defined yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
const roleForm = document.getElementById('role-form');
const roleNameInput = document.getElementById('role-name');
const addBtn = document.getElementById('add-btn');
const saveBtn = document.getElementById('save-btn');
const editBtn = document.getElementById('edit-btn');
const roleSelect = document.getElementById('role-select');

let editingRole = null;

// Disable Add button if no role name
roleNameInput.addEventListener('input', () => {
    addBtn.disabled = !roleNameInput.value.trim();
});

// Collect role permissions from checkboxes
function collectPermissions() {
    return Array.from(roleForm.querySelectorAll('input[type="checkbox"]:checked'))
        .reduce((acc, cb) => {
            acc[cb.id] = true;
            return acc;
        }, {});
}

// Populate checkboxes for a role
function populatePermissions(roleData) {
    // Reset all checkboxes
    roleForm.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    if (roleData && roleData.permissions) {
        roleData.permissions.forEach(perm => {
            const cb = document.getElementById(perm.key);
            if (cb) cb.checked = true;
        });
    }
}

// Add new role
roleForm.addEventListener('submit', e => {
    e.preventDefault();
    const roleName = roleNameInput.value.trim();
    if (!roleName) return;

    const checkedBoxes = collectPermissions();

    fetch('/get-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            created_role: roleName,
            role_apps: checkedBoxes
        })
    })
    .then(res => res.json())
    .then(() => {
        roleForm.reset();
        addBtn.disabled = true;
    });

    console.log("Added:", roleName, checkedBoxes);
});

// Edit existing role
editBtn.addEventListener('click', () => {
    const selectedRole = roleSelect.value;
    if (!selectedRole) return;

    fetch(`/get-role/${selectedRole}`)
        .then(res => res.json())
        .then(roleData => {
            roleNameInput.value = roleData.name;
            populatePermissions(roleData);
            editingRole = roleData.name;

            addBtn.style.display = "none";
            saveBtn.style.display = "inline-block";
        });
});

// Save edited role
saveBtn.addEventListener('click', () => {
    if (!editingRole) return;

    const checkedBoxes = collectPermissions();

    fetch('/update-role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            role_name: editingRole,
            updated_role_apps: checkedBoxes
        })
    })
    .then(res => res.json())
    .then(() => {
        editingRole = null;
        roleForm.reset();
        saveBtn.style.display = "none";
        addBtn.style.display = "inline-block";
        addBtn.disabled = true;
    });

    console.log("Updated:", editingRole, checkedBoxes);
});
</script>
{% endblock %}
